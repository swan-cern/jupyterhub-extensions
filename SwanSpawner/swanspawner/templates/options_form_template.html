<style> .nb{ font-weight:normal } </style>
<style> .nbs{ font-weight:normal; font-size:small } </style>
<style> .news{ font-weight:normal; background-color:yellow } </style>
<script type="text/javascript">
<!--

    var lcgFormConfig = {{ options_form_config }};

    var accpyVersions = ["2020.11", "2021.12", "2023.06"];

    var formInitialized = false;

    /**
     * Get LCG data dictionary for given lcgValue.
     */
    function findLcgData(lcgValue) {
        var lcgData;

        // Data is taken from from lcgFormConfig global variable
        var lcgFormOptions = lcgFormConfig['options'];
        for (key in lcgFormOptions) {
            lcgData = lcgFormOptions[key];
            if (lcgData.type === "selection" && lcgData.lcg.value === lcgValue) {
                return lcgData;
            }
        }

        throw "LCG Data not found"
    }

    /*
     * Selects AlmaLinux 9 in the LCG plataform options
     */
    function selectAlma9(selector) {
        for (var i = 0; i < selector.options.length; i++) {
            if (selector.options[i].text.startsWith('AlmaLinux 9')) {
                selector.options[i].selected = true;
                break;
            }
        }
        selector.setAttribute('disabled', '');
    }
    
    /*
    * Selects default LCG release (105)
    */
   function selectDefaultLCG(selector) {
        for (var i = 0; i < selector.options.length; i++) {
           if (selector.options[i].value === '105') {
               selector.options[i].selected = true;
               break;
            }
        }
        selector.setAttribute('disabled', '');
    }

    /**
     * Enable display of element if previously disabled, and disable if previously enabled
     */
    function toggle_visibility(id) {
        var e = document.getElementById(id);
        if(e.style.display == 'block')
            e.style.display = 'none';
        else
            e.style.display = 'block';
    }

    /**
     * Renders a form based on config file
     */
    function adjust_form() {
        var selectLCG = document.getElementById('lcgReleaseOptions');

        // if form has not been yet initialized, initialize
        if (!formInitialized) {
            formInitialized = true;

            // set proper header for the whole form based on config
            var optionsHeader = document.getElementById('optionsHeader');
            var header = lcgFormConfig['header'];
            if (header) {
                optionsHeader.innerHTML = header;
            }

            // set LCG option in the rendered form - first LCG is default
            var lcgFormOptions = lcgFormConfig['options'];
            selectLCG.innerHTML = '';
            var firstLCGSelected = false;
            for( var i = 0 ; i < lcgFormOptions.length ; i++ ){
                var lcgFormEntry = lcgFormOptions[i];

                var selectLCGOption = document.createElement("option");
                if (lcgFormEntry.type === "label") {
                    selectLCGOption.disabled="disabled";
                    selectLCGOption.style="border-bottom:1px solid rgba(153,153,153,.3); margin:-10px 0 4px 0";
                    selectLCGOption.value=lcgFormEntry.label.value;
                    selectLCGOption.text=lcgFormEntry.label.text;
                } else {
                    if (!firstLCGSelected) {
                        firstLCGSelected = true;
                        selectLCGOption.selected = true;
                    }
                    selectLCGOption.value=lcgFormEntry.lcg.value;
                    selectLCGOption.text=lcgFormEntry.lcg.text;
                }

                selectLCG.add(selectLCGOption);
            }
        }

        // get currently selected LCG and extract that lcg configuration (lcgData)
        var lcgValue = selectLCG.value;
        var lcgData = findLcgData(lcgValue);

        // adjust platforms option for lcg
        var selectPlatform = document.getElementById('platformOptions');
        selectPlatform.innerHTML = '';

        for( var i = 0 ; i < lcgData.platforms.length ; i++ ){
            var lcgPlatform = lcgData.platforms[i];

            var selectPlatformOption = document.createElement("option");
            selectPlatformOption.value = lcgPlatform.value;
            selectPlatformOption.text = lcgPlatform.text;
            if (i === 0) {
                selectPlatformOption.selected = true;
            }

            selectPlatform.add(selectPlatformOption);
        }

        // adjust cores option for lcg
        var selectCores = document.getElementById('coresOptions');
        selectCores.innerHTML = '';

        for( var i = 0 ; i < lcgData.cores.length ; i++ ){
            var lcgCores = lcgData.cores[i];

            var selectCoresOption = document.createElement("option");
            selectCoresOption.value = lcgCores.value;
            selectCoresOption.text = lcgCores.text;
            if (i === 0) {
                selectCoresOption.selected = true;
            }

            selectCores.add(selectCoresOption);
        }

        // adjust memory option for lcg
        var selectMemory = document.getElementById('memoryOptions');
        selectMemory.innerHTML = '';

        for( var i = 0 ; i < lcgData.memory.length ; i++ ){
            var lcgMemory = lcgData.memory[i];

            var selectMemoryOption = document.createElement("option");
            selectMemoryOption.value = lcgMemory.value;
            selectMemoryOption.text = lcgMemory.text;
            if (i === 0) {
                selectMemoryOption.selected = true;
            }

            selectMemory.add(selectMemoryOption);
        }

        // adjust clusters option for lcg
        var selectCluster = document.getElementById('clusterOptions');
        selectCluster.innerHTML = '';
        // Make sure Spark cluster options are enabled on LCG release change
        selectCluster.removeAttribute('disabled');

        for( var i = 0 ; i < lcgData.clusters.length ; i++ ){
            var lcgCluster = lcgData.clusters[i];

            var selectClusterOption = document.createElement("option");
            selectClusterOption.value = lcgCluster.value;
            selectClusterOption.text = lcgCluster.text;
            if (i === 0) {
                selectClusterOption.selected = true;
            }

            selectCluster.add(selectClusterOption);
        }

        // adjust condor option for lcg
        var selectCondor = document.getElementById('condorOptions');
        selectCondor.innerHTML = '';

        for( var i = 0 ; i < lcgData.condor.length ; i++ ){
            var lcgCondor = lcgData.condor[i];

            var selectCondorOption = document.createElement("option");
            selectCondorOption.value = lcgCondor.value;
            selectCondorOption.text = lcgCondor.text;
            if (i === 0) {
                selectCondorOption.selected = true;
            }

            selectCondor.add(selectCondorOption);
        }

        // adjust accpy versions option for customenvs
        var selectAccpy = document.getElementById('accpyOptions');
        selectAccpy.innerHTML = '';

        accpyVersions.forEach(version => {
            var selectAccpyOption = document.createElement("option");
            selectAccpyOption.value = version;
            selectAccpyOption.text = version;
            selectAccpy.add(selectAccpyOption);
        });
        selectAccpy.selectedIndex = 0;
    }

    function adjust_customenv() {
        adjust_form();
        var lcgOption = document.getElementById('lcgOption');
        var customenvOption = document.getElementById('customenvOption');
        
        var customenv_config = document.getElementById('customenv_config');
        var external_config = document.getElementById('external_config');
        
        var lcgSection = document.getElementById('lcgSection');
        var lcgReleaseOptions = document.getElementById('lcgReleaseOptions');
        var platformOptions = document.getElementById('platformOptions');
        
        if (lcgOption.checked) {
            customenv_config.style.display = 'none';
            external_config.style.display = 'block';
            lcgSection.style.visibility = 'visible';
            lcgReleaseOptions.removeAttribute('disabled');
            lcgReleaseOptions.selectedIndex = 1;
            platformOptions.selectedIndex = 0;
            platformOptions.removeAttribute('disabled');
            adjust_spark();
        } else if (customenvOption.checked ) {
            customenv_config.style.display = 'block';
            external_config.style.display = 'none';
            selectDefaultLCG(lcgReleaseOptions);
            selectAlma9(platformOptions);
            adjust_accpy();
        } 
    }

    function adjust_accpy() {
        var accpyOption = document.getElementById('accpyOption');
        var cvmfsOption = document.getElementById('cvmfsOption');
        var otherOption = document.getElementById('otherOption');
        
        var lcgSection = document.getElementById('lcgSection');
        var accpySection = document.getElementById('accpySection');
        var pythonSection = document.getElementById('pythonSection');

        lcgSection.style.visibility = !cvmfsOption.checked ? 'hidden' : 'visible';
        accpySection.style.display = !accpyOption.checked ? 'none' : 'block';
        pythonSection.style.display = !otherOption.checked ? 'none' : 'block';
    }


    /**
     * Modifies the selection of Spark clusters depending on the chosen platform
     */
    function adjust_spark() {
        var platformOptions = document.getElementById('platformOptions');
        var clusterOptions  = document.getElementById('clusterOptions');

        var isAlma = platformOptions.selectedOptions[0].text.startsWith('AlmaLinux 9');

        if (isAlma) {
            // Disable Spark cluster selection, since Spark is still not supported on Alma9
            clusterOptions.setAttribute('disabled', '');
            clusterOptions.selectedIndex = 0;
        } else {
            // On CentOS7, make sure cluster selection is enabled
            clusterOptions.removeAttribute('disabled');
        }
    }

    window.onload = adjust_form;
//-->
</script>

<div>
    <label for="placeholder">
    <span class='nb' id="optionsHeader">Specify the configuration parameters for the SWAN container that will be created for you.</span>
    </label>
    <label for="alma9">
    <span class='news' id="alma9">Select <b>AlmaLinux 9</b> as Platform to try out our new experimental Alma9 image with <b>JupyterLab</b> as default interface! More information <a target="_blank" href="https://swan.docs.cern.ch/alma9/">here</a>.</span>
    </label>
    <br><br>

    <div>
        <label>Configuration <a href="#" onclick="toggle_visibility('configDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="configDetails">
                <span class='nb'>Configuration type for your container.</span>
            </div>
        </label>
        <br>
        <input type="radio" id="lcgOption" name="configType" value="lcg" checked onclick="adjust_customenv();" style="width: auto; height: auto; display: inline-block;">
        <label for="lcgOption" style="margin-right: 5%;">LCG</label>
        <input type="radio" id="customenvOption" name="configType" value="customenv" onclick="adjust_customenv();" style="width: auto; height: auto; display: inline-block;">
        <label for="customenvOption">Custom Environment</label>
    </div>
    <br>

    <div id="lcgSection">
        <label for="lcgReleaseOptions">Software stack <a href="#" onclick="toggle_visibility('lcgReleaseDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="lcgReleaseDetails">
                <span class='nb'>The software stack to associate to the container. See the <a target="_blank" href="http://lcginfo.cern.ch/">LCG package info</a> page.</span>
            </div>
        </label>
        <select id="lcgReleaseOptions" name="LCG-rel" onchange="adjust_form();">
        </select>
    </div>
    <br>
    
    <div id="plataformSection">
        <label for="platformOptions">Platform <a href="#" onclick="toggle_visibility('platformDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="platformDetails">
                <span class='nb'>The combination of compiler version and flags.</span>
            </div>
        </label>
        <select id="platformOptions" name="platform" onchange="adjust_spark();"></select>
    </div>
    <br>
    
    <div id="scriptenvSection">
        <label for="scriptenvOption">Environment script <a href="#" onclick="toggle_visibility('scriptenvDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="scriptenvDetails">
                <span class='nb'>User-provided bash script to define custom environment variables. The variable CERNBOX_HOME is resolved to the proper /eos/user/u/username directory.</span>
            </div>
        </label>
        <input type="text" id="scriptenvOption" name="scriptenv" placeholder="e.g. $CERNBOX_HOME/MySWAN/myscript.sh">
    </div>
    <br>
    
    <div id="coresSection">
        <label for="coresOptions">Number of cores <a href="#" onclick="toggle_visibility('ncoresDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="ncoresDetails">
                <span class='nb'>Number of cores to associate to the container.</span>
            </div>
        </label>
        <select id="coresOptions" name="ncores"></select>
    </div>
    <br>

    <div id="memorySection">
        <label for="memoryOptions">Memory <a href="#" onclick="toggle_visibility('memoryDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="memoryDetails">
                <span class='nb'>Amount of Memory allocated to the container.</span>
            </div>
        </label>
        <select id="memoryOptions" name="memory"></select>
    </div>
    <br>

    <!-- Custom environment configuration -->
    <div id="customenv_config" style="display: none;">
        <h2 for="computing-resources">Custom environment configuration</h2>
        
        <div id="envnameSection">
            <label for="envnameOption">Environment <a href="#" onclick="toggle_visibility('envnameDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="envnameDetails">
                    <span class='nb'>Name of the new environment to create.</span>
                </div>
            </label>
            <input type="text" id="envnameOption" name="env_name" placeholder="e.g. env1">
        </div>
        <br>

        <div id="requirementsSection">
            <label for="requirementsOption">Requirements <a href="#" onclick="toggle_visibility('requirementsDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="requirementsDetails">
                    <span class='nb'>Path to a requirements file stored in your <a target="_blank" href="https://cernbox.cern.ch/">CERNBox</a>, or a <a target="_blank" href="https://github.com/new/">GitHub</a>/<a target="_blank" href="https://gitlab.cern.ch/projects/new">CERN GitLab</a> repository containing a requirements.txt in its root path.</span>
                </div>
            </label>
            <input type="text" id="requirementsOption" name="req" placeholder="e.g. SWAN_projects/requirements.txt, https://github.com/user/env1">
        </div>
        <br>

        <div id="customenvTypeSection" style="display: block;">
            <label>Custom environment type <a href="#" onclick="toggle_visibility('customenvDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="customenvDetails">
                    <span class='nb'>Type of custom environment to create.</span>
                </div>
            </label>
            <br>
            <input type="radio" id="cvmfsOption" name="customenvType" value="cvmfs" checked onclick="adjust_accpy();" style="width: auto; height: auto; display: inline-block;">
            <label for="cvmfsOption" style="margin-right: 5%;">CVMFS Python</label>
            <input type="radio" id="accpyOption" name="customenvType" value="accpy" onclick="adjust_accpy();" style="width: auto; height: auto; display: inline-block;">
            <label for="accpyOption" style="margin-right: 5%;">Acc-Py</label>
            <input type="radio" id="otherOption" name="customenvType" value="custom_python" onclick="adjust_accpy();" style="width: auto; height: auto; display: inline-block;">
            <label for="otherOption" style="margin-right: 5%;">Other</label>
        </div>
        <br>
        <div id="accpySection" style="display: none;">
            <label for="accpyOptions">Acc-Py Version <a href="#" onclick="toggle_visibility('accpyDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="accpyDetails">
                    <span class='nb'>Version for Acc-Py. See more in the <a target="_blank" href="https://confluence.cern.ch/display/ACCPY/Getting+started+with+Acc-Py">Acc-Py User guide</a></span>
                </div>
            </label>
            <select id="accpyOptions" name="accpy_version"></select>
        </div>
        <div id="pythonSection" style="display: none;">
            <label for="pythonOption">Python path <a href="#" onclick="toggle_visibility('pythonDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="pythonDetails">
                    <span class='nb'>Path for an alternative Python binary</span>
                </div>
            </label>
            <input type="text" id="pythonOption" name="accpy_version" placeholder="e.g. /usr/bin/python3">
        </div>
        <br>
    </div>

    <!-- External computing resources -->
    <div id="external_config" style="display: block;">
        <h2 for="computing-resources">External computing resources</h2>
        
        <div id="clusterSection">
            <label for="clusterOptions">Spark cluster <a href="#" onclick="toggle_visibility('clusterDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="clusterDetails">
                    <span class='nb'>Name of the Spark cluster to connect to from notebooks. See the <a target="_blank" href="https://hadoop-user-guide.web.cern.ch/">Hadoop User guide</a> and the <a target="_blank" href="https://sparktraining.web.cern.ch/">Spark training course</a></span>
                </div>
            </label>
            <select id="clusterOptions" name="spark-cluster"></select>
        </div>
        <br>

        <div id="condorSection">
            <label for="condorOptions">HTCondor pool <a href="#" onclick="toggle_visibility('condorDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="condorDetails">
                    <span class='nb'>Name of the HTCondor pool to use.</span>
                </div>
            </label>
            <select id="condorOptions" name="condor-pool"></select>
        </div>
    </div>
</div>
