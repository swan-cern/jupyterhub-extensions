<style> .nb{ font-weight:normal } </style>
<style> .nbs{ font-weight:normal; font-size:small } </style>
<style> .news{ font-weight:normal; background-color:yellow } </style>
<script type="text/javascript">
<!--

    var formConfig = {{ options_form_config }};

    var formInitialized = false;

    /**
     * Get Form data dictionary for given selectedValue.
     */
    function findFormData(form, formElement, value) {
        // Data is taken from formConfig global variable
        var formOptions = formConfig[form];
        for (key in formOptions) {
            const formData = formOptions[key];
            if (formData.type === "selection" && formData[formElement].value === value) {
                return formData;
            }
        }

        throw `${formElement} Data not found`
    }

    /**
     * Enable display of element if previously disabled, and disable if previously enabled
     */
    function toggle_visibility(id) {
        var e = document.getElementById(id);
        if(e.style.display == 'block')
            e.style.display = 'none';
        else
            e.style.display = 'block';
    }

    /**
     * Renders a form based on config file
     */
    function adjust_form() {
        const sourceOptions = document.getElementsByName('software_source');
        let selectedSource = null;
        for (let i = 0; i < sourceOptions.length; i++) {
            if (sourceOptions[i].checked) {
                selectedSource = sourceOptions[i].value;
                break;
            }
        }

        var sourceConfig = {
            lcg: {
                optionsElement: document.getElementById("lcgReleaseOptions"),
                sourceForm: "lcg_options",
                formElement: "lcg",
            },
            customenv: {
                optionsElement: document.getElementById("builderOptions"),
                sourceForm: "customenv_options",
                formElement: "builder",
            }
        };

        // if form has not been yet initialized, initialize
        if (!formInitialized) {
            formInitialized = true;

            // set proper header for the whole form based on config
            var optionsHeader = document.getElementById('optionsHeader');
            var header = formConfig['header'];
            if (header) {
                optionsHeader.innerHTML = header;
            }

            // Loop through all source types and populate the main dropdown options (lcg -> lcg_release, customenv -> builder)
            for (var source in sourceConfig) {
                const currentSource = sourceConfig[source];
                const formOptions = formConfig[currentSource.sourceForm];
                currentSource.optionsElement.innerHTML = '';
                var firstFormOptionselected = false;

                for( var i = 0 ; i < formOptions.length ; i++ ){
                    var formEntry = formOptions[i];
                    var formOption = document.createElement("option");

                    if (formEntry.type === "label") {
                        formOption.disabled = "disabled";
                        formOption.style = "border-bottom:1px solid rgba(153,153,153,.3); margin:-10px 0 4px 0";
                        formOption.value = formEntry.label.value;
                        formOption.text = formEntry.label.text;
                    } else {
                        if (!firstFormOptionselected) {
                            firstFormOptionselected = true;
                            formOption.selected = true;
                        }
                        formOption.value = formEntry[currentSource.formElement].value;
                        formOption.text = formEntry[currentSource.formElement].text;
                    }

                    currentSource.optionsElement.add(formOption);
                }
            }
        }

        // get currently selected source and extract its configuration (formData)
        const selectedConfig = sourceConfig[selectedSource];
        var selectedValue = selectedConfig.optionsElement.value;
        var formData = findFormData(selectedConfig.sourceForm, selectedConfig.formElement, selectedValue);

        var available_configs = {
            'lcg': [
                {elementName: 'platformOptions', formKey: "platforms"}, 
                {elementName: 'coresOptions', formKey: "cores"}, 
                {elementName: 'memoryOptions', formKey: "memory"}, 
                {elementName: 'clusterOptions', formKey: "clusters"}, 
                {elementName: 'condorOptions', formKey: "condor"}
            ],
            'customenv': [
                {elementName: 'coresOptions', formKey: "cores"},
                {elementName: 'memoryOptions', formKey: "memory"}
            ]
        };

        // Populate the form according to main dropdown selection
        available_configs[selectedSource].forEach(function(config) {
            var configElement = document.getElementById(config.elementName);
            configElement.innerHTML = '';

            for( var i = 0 ; i < formData[config.formKey].length ; i++ ){
                var formOption = formData[config.formKey][i];

                var selectOption = document.createElement("option");
                selectOption.value = formOption.value;
                selectOption.text = formOption.text;
                if (i === 0) {
                    selectOption.selected = true;
                }

                configElement.add(selectOption);
            }
        });
    }

    /**
     * Adjusts the width of the repository type dropdown element based on the selected option
     */
    function adjust_repository_dropdown() {
        const selectElement = document.getElementById('repository_type_dropdown');
        const selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
        const tempElement = document.createElement('span');
        tempElement.style.visibility = 'hidden';
        tempElement.style.whiteSpace = 'nowrap';
        tempElement.style.fontSize = window.getComputedStyle(selectElement).fontSize;
        tempElement.innerHTML = selectedOptionText;
        
        document.body.appendChild(tempElement);
        const width = tempElement.offsetWidth;
        document.body.removeChild(tempElement);
        
        selectElement.style.width = `${width + 50}px`;

        const repositoryOption = document.getElementById('repositoryOption');
        if (selectElement.value === 'eos') {
            repositoryOption.placeholder = 'e.g. $CERNBOX_HOME/MyFolder';
        } else if (selectElement.value === 'git') {
            repositoryOption.placeholder= "e.g. https://gitlab.cern.ch/user/myrepo";
        }
    }

    /**
     * Modifies the displayed form according to the selected type of configuration (LCG or Custom Environments)
     */
    function toggle_form() {
        var lcgOption = document.getElementById('lcgOption');

        var customenv_config = document.getElementById('customenv_config');
        var external_res_config = document.getElementById('external_res_config');
        var lcg_config = document.getElementById('lcg_config');

        adjust_form();
        if (lcgOption.checked) {
            lcg_config.style.display = 'block';
            customenv_config.style.display = 'none';
            external_res_config.style.display = 'block';
            adjust_spark();
        } else {
            adjust_repository_dropdown();
            lcg_config.style.display = 'none';
            customenv_config.style.display = 'block';
            external_res_config.style.display = 'none';
        } 
    }

    /**
     * Modifies the selection of Spark clusters depending on the chosen platform
     */
    function adjust_spark() {
        var platformOptions = document.getElementById('platformOptions');

        function removeCluster(cluster) {
            var clusterOptions  = document.getElementById('clusterOptions');
            for (var i = 0; i < clusterOptions.options.length; i++) {
                if (clusterOptions.options[i].value === cluster) {
                    clusterOptions.remove(i);
                    break;
                }
            }
        }

        function addCluster(clusterValue, clusterName) {
            var selectClusterOption = document.createElement("option");
            selectClusterOption.value = clusterValue;
            selectClusterOption.text = clusterName;
            clusterOptions.add(selectClusterOption);
        }

        var isAlma = platformOptions.selectedOptions[0].text.startsWith('AlmaLinux 9');

        if (isAlma) {
            clusterOptions.selectedIndex = 0;
            removeCluster("analytix")
            addCluster("k8s", "Cloud Containers (K8s)")
            addCluster("hadoop-qa", "QA")
        }
        else {
            addCluster("analytix", "General Purpose (Analytix)")
            removeCluster("k8s")
            removeCluster("hadoop-qa")
        }
    }

    window.onload = toggle_form;
//-->
</script>

<div>
    <label for="placeholder">
    <span class='nb' id="optionsHeader">Specify the configuration parameters for the SWAN container that will be created for you.</span>
    </label>
    <label for="alma9">
    <span class='news' id="alma9">Select <b>AlmaLinux 9</b> as Platform to try out our new experimental Alma9 image with <b>JupyterLab</b> as default interface! More information <a target="_blank" href="https://swan.docs.cern.ch/alma9/">here</a>.</span>
    </label>
    <br><br>

    <!-- Source Type selection -->
    <div id="software_sourceSection">
        <h2>Software</h2>
        <label>Source <a href="#" onclick="toggle_visibility('sourceDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="sourceDetails">
                <span class='nb'>Software source: curated stack (LCG) or custom environment.</span>
            </div>
        </label>
        <br>
        <input type="radio" id="lcgOption" name="software_source" value="lcg" checked onchange="toggle_form();" style="width: auto; height: auto; display: inline-block;">
        <label for="lcgOption" style="margin-right: 5%;">LCG</label>
        <input type="radio" id="customenvOption" name="software_source" value="customenv" onchange="toggle_form();" style="width: auto; height: auto; display: inline-block;">
        <label for="customenvOption">Custom Environment</label>
        <br><br>
    </div>
    
    <!-- LCG configuration -->
    <div id="lcg_config">
        <div id="lcgReleaseSection">
            <label for="lcgReleaseOptions">Software stack <a href="#" onclick="toggle_visibility('lcgReleaseDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="lcgReleaseDetails">
                    <span class='nb'>LCG release to use as software source. See the <a target="_blank" href="http://lcginfo.cern.ch/">LCG releases package info</a> page.</span>
                </div>
            </label>
            <select id="lcgReleaseOptions" name="LCG-rel" onchange="adjust_form();">
            </select>
        </div>
        <br>
        
        <div id="platformSection">
            <label for="platformOptions">Platform <a href="#" onclick="toggle_visibility('platformDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="platformDetails">
                    <span class='nb'>Operating system and compiler version.</span>
                </div>
            </label>
            <select id="platformOptions" name="platform" onchange="adjust_spark();"></select>
        </div>
        <br>
        
        <div id="scriptenvSection">
            <label for="scriptenvOption">Environment script <a href="#" onclick="toggle_visibility('scriptenvDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="scriptenvDetails">
                    <span class='nb'>User-provided bash script to define custom environment variables. The variable CERNBOX_HOME is resolved to the proper /eos/user/u/username directory.</span>
                </div>
            </label>
            <input type="text" id="scriptenvOption" name="scriptenv" placeholder="e.g. $CERNBOX_HOME/MySWAN/myscript.sh">
        </div>
        <br>
    </div>

    <!-- Custom environment configuration -->
    <div id="customenv_config" style="display: none;">
        <div id="repositorySection">
            <label for="repositoryOption">Repository 
                <a href="#" onclick="toggle_visibility('repositoryDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="repositoryDetails">
                    <span class='nb'>Repository containing a requirements.txt file. It can be a path on EOS or the URL of a public git repository.</span>
                </div>
            </label>
            <br>
            <div style="display: flex;">
                <select id="repository_type_dropdown" name="repository_type" onchange="adjust_repository_dropdown();" style="width: auto; display: inline-flex; border: 1px solid #afafaf; background-color: #efefef;">
                    <option value="eos">EOS</option>
                    <option value="git">Git</option>
                </select>
                <input type="text" id="repositoryOption" name="repository" style="flex-grow: 1; margin-left: 0; border: 1px solid #afafaf;">
            </div>
        </div>
        <br>
        
        <div id="builderSection">
            <label for="builderOptions">Builder <a href="#" onclick="toggle_visibility('builderDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="builderDetails">
                    <span class='nb'>Program responsible for building the custom environment (generic or community-specific).</a></span>
                </div>
            </label>
            <select id="builderOptions" name="builder"></select>
        </div>
        <br>
    </div>
    
    <!-- Resources configuration -->
    <div id="resources_config">
        <h2>Session resources</h2>

        <div id="coresSection">
            <label for="coresOptions">Number of cores <a href="#" onclick="toggle_visibility('ncoresDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="ncoresDetails">
                    <span class='nb'>Amount of cores allocated to the container.</span>
                </div>
            </label>
            <select id="coresOptions" name="ncores"></select>
        </div>
        <br>

        <div id="memorySection">
            <label for="memoryOptions">Memory <a href="#" onclick="toggle_visibility('memoryDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="memoryDetails">
                    <span class='nb'>Amount of memory allocated to the container.</span>
                </div>
            </label>
            <select id="memoryOptions" name="memory"></select>
        </div>
        <br>
    </div>

    <!-- External computing resources -->
    <div id="external_res_config" style="display: block;">
        <h2>External computing resources</h2>
        
        <div id="clusterSection">
            <label for="clusterOptions">Spark cluster <a href="#" onclick="toggle_visibility('clusterDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="clusterDetails">
                    <span class='nb'>Name of the Spark cluster to connect to from notebooks. See the <a target="_blank" href="https://hadoop-user-guide.web.cern.ch/">Hadoop User guide</a> and the <a target="_blank" href="https://sparktraining.web.cern.ch/">Spark training course</a></span>
                </div>
            </label>
            <select id="clusterOptions" name="spark-cluster"></select>
        </div>
        <br>

        <div id="condorSection">
            <label for="condorOptions">HTCondor pool <a href="#" onclick="toggle_visibility('condorDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="condorDetails">
                    <span class='nb'>Name of the HTCondor pool to use.</span>
                </div>
            </label>
            <select id="condorOptions" name="condor-pool"></select>
        </div>
    </div>
</div>
