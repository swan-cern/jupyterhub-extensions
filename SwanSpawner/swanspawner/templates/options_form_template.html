<style> .nb{ font-weight:normal } </style>
<style> .nbs{ font-weight:normal; font-size:small } </style>
<style> .news{ font-weight:normal; background-color:yellow } </style>
<script type="text/javascript">
<!--

    var formConfig = {{ options_form_config }};

    var formInitialized = false;
    var previous_jupyterlab = undefined;

    var sourceConfig = {
        lcg: {
            optionsElement: "lcgOptions",
            sourceForm: "lcg_options",
            formElement: "lcg",
        },
        customenv: {
            optionsElement: "builderOptions",
            sourceForm: "customenv_options",
            formElement: "builder",
        }
    };

    /**
     * Get Form data dictionary for given selectedValue.
     */
    function findFormData(form, formElement, value) {
        // Data is taken from formConfig global variable
        var formOptions = formConfig[form];
        for (key in formOptions) {
            const formData = formOptions[key];
            if (formData.type === "selection" && formData[formElement].value === value) {
                return formData;
            }
        }

        throw `${formElement} Data not found`
    }

    /**
     * Get the value of the first selectable option in the given select element
     */
    function get_default_option(id) {
        return document.getElementById(id).selectedOptions[0].value;
    }
    /**
     * Set the given input with the specified value
     */
    function set_input(id, value) {
        document.getElementById(id).value = value;
    }
    /**
     * Loops throught the elements keys and selects the option with the given value
     */
    function set_options(elements) {
        for (var id in elements) {
            set_input(id, elements[id]);
        }
    }
    /**
     * (Un)check the element with the given id
     */
    function set_checkbox(id, checked) {
        document.getElementById(id).checked = checked;
    }

    /**
     * Build a simple error message on top of Header
     */
    function build_error_message(message) {
        const error_message = document.createElement('span');
        error_message.style.color = 'red';
        error_message.innerHTML = message;
        error_message.appendChild(document.createElement('br'));
        const optionsHeader = document.getElementById('optionsHeader');
        if (!optionsHeader.querySelector('span')) {
            optionsHeader.insertBefore(error_message, optionsHeader.firstChild);
        }
    }

    /**
     * Enable display of element if previously disabled, and disable if previously enabled
     */
    function toggle_visibility(id) {
        var e = document.getElementById(id);
        if(e.style.display == 'block')
            e.style.display = 'none';
        else
            e.style.display = 'block';
    }

    /**
     * Enable display of element if previously disabled, and disable if previously enabled
     */
    function validate_repository_input() {
        var repoInput = document.getElementById('repositoryOption');
        const repoPattern = /^https?:\/\/(?:github\.com|gitlab\.cern\.ch)\/([a-zA-Z0-9_-]+)\/([a-zA-Z0-9_-]+)(\/|\.git)?$/.test(repoInput.value);
        if (repoInput.value && !repoPattern) {
            repoInput.style.backgroundColor = '#ffcccc';
        } else {
            repoInput.style.backgroundColor = '#ffffff';
        }
    }

    /**
     * Renders a form based on config file
     */
    function adjust_form() {
        let selectedSource = document.querySelector('input[name="software_source"]:checked').value;

        // if form has not been yet initialized, initialize
        if (!formInitialized) {
            formInitialized = true;

            // set proper header for the whole form based on config
            var optionsHeader = document.getElementById('optionsHeader');
            var header = formConfig['header'];
            if (header) {
                optionsHeader.innerHTML = header;
            }

            // Loop through all source types and populate the main dropdown options (lcg -> lcg_release, customenv -> builder)
            for (var source in sourceConfig) {
                const currentSource = sourceConfig[source];
                const formOptions = formConfig[currentSource.sourceForm];
                document.getElementById(currentSource.optionsElement).innerHTML = '';
                var firstFormOptionselected = false;

                for( var i = 0 ; i < formOptions.length ; i++ ){
                    var formEntry = formOptions[i];
                    var formOption = document.createElement("option");

                    if (formEntry.type === "label") {
                        formOption.disabled = "disabled";
                        formOption.style = "border-bottom:1px solid rgba(153,153,153,.3); margin:-10px 0 4px 0";
                        formOption.value = formEntry.label.value;
                        formOption.text = formEntry.label.text;
                    } else {
                        if (!firstFormOptionselected) {
                            firstFormOptionselected = true;
                            formOption.selected = true;
                        }
                        formOption.value = formEntry[currentSource.formElement].value;
                        formOption.text = formEntry[currentSource.formElement].text;
                    }

                    document.getElementById(currentSource.optionsElement).add(formOption);
                }
            }
        }

        // get currently selected source and extract its configuration (formData)
        const selectedConfig = sourceConfig[selectedSource];
        var selectedValue = document.getElementById(selectedConfig.optionsElement).value;
        var formData = findFormData(selectedConfig.sourceForm, selectedConfig.formElement, selectedValue);

        var available_configs = {
            'lcg': [
                {elementName: 'platformOptions', formKey: 'platforms'}, 
                {elementName: 'coresOptions', formKey: 'cores'}, 
                {elementName: 'memoryOptions', formKey: 'memory'}, 
                {elementName: 'clusterOptions', formKey: 'clusters'}, 
                {elementName: 'condorOptions', formKey: 'condor'}
            ],
            'customenv': [
                {elementName: 'coresOptions', formKey: 'cores'},
                {elementName: 'memoryOptions', formKey: 'memory'},
                {elementName: 'clusterOptions', formKey: 'clusters'}, 
            ]
        };

        // Populate the form according to main dropdown selection
        available_configs[selectedSource].forEach(function(config) {
            var configElement = document.getElementById(config.elementName);
            configElement.innerHTML = '';

            for( var i = 0 ; i < (formData[config.formKey] || []).length ; i++ ){
                var formOption = formData[config.formKey][i];

                var selectOption = document.createElement("option");
                selectOption.value = formOption.value;
                selectOption.text = formOption.text;
                if (i === 0) {
                    selectOption.selected = true;
                }

                configElement.add(selectOption);
            }
        });

        adjust_options();
    }

    /**
     * Modifies the selection of Spark clusters and enables users to choose
     * to use the JupyterLab interface depending on the chosen platform
     */
    function adjust_options() {
        var platformOptions = document.getElementById('platformOptions');
        var clusterOptions  = document.getElementById('clusterOptions');
        var jupyterLabOption = document.getElementById("use-jupyterlab");
        var useLocalPackagesOption = document.getElementById('use-local-packages');

        /**
         * Store the chosen platform in a hidden form field, as disabled fields
         * are not sent in the request
         */ 
        var hiddenPlatformOptions = document.getElementById('hiddenPlatformOptions');

        var isAlma = (platformOptions.selectedOptions[0] && platformOptions.selectedOptions[0].text.startsWith('AlmaLinux 9'));
        var isNXCALS = (clusterOptions.selectedOptions[0] && clusterOptions.selectedOptions[0].text.startsWith('BE NXCALS (NXCals)'));

        if (isAlma) {
            /* On Alma9, make sure cluster selection is enabled and that users can
            select the JupyterLab interface */
            clusterOptions.removeAttribute('disabled');
            jupyterLabOption.removeAttribute('disabled');
            useLocalPackagesOption.removeAttribute('disabled');
        } else {
            if (!isNXCALS) {
                clusterOptions.setAttribute('disabled', '');
                clusterOptions.selectedIndex = 0;
            }

            jupyterLabOption.setAttribute('disabled', '');
            useLocalPackagesOption.setAttribute('disabled', '');
        }

        hiddenPlatformOptions.value = platformOptions.value;
    }

    function adjust_platforms() {
        var platformOptions = document.getElementById('platformOptions');
        var jupyterLabOption = document.getElementById('use-jupyterlab');
        var useLocalPackagesOption = document.getElementById('use-local-packages');

        if (jupyterLabOption.checked || useLocalPackagesOption.checked) {
            platformOptions.setAttribute('disabled', '');
        } else {
            platformOptions.removeAttribute('disabled');
        }
    }

    /**
     * Modifies the displayed form according to the selected type of configuration (LCG or Custom Environments)
     * If the builder is accpy, the external resources configuration is displayed (without condor)
     */
    function adjust_clusters(external_res_config, condorSection, lcg_config, customenv_config, jupyterLabOption) {
        var builderOptions = document.getElementById('builderOptions');
        var external_res_config = external_res_config || document.getElementById('external_res_config');
        var condorSection = condorSection || document.getElementById('condorSection');
        var lcg_config = lcg_config || document.getElementById('lcg_config');
        var customenv_config = customenv_config || document.getElementById('customenv_config');
        var jupyterLabOption = jupyterLabOption || document.getElementById('use-jupyterlab');

        if (builderOptions.options[builderOptions.selectedIndex].value.startsWith('accpy')) {
            external_res_config.style.display = 'block';
            condorSection.style.display = 'none';
        } else {
            external_res_config.style.display = 'none';
            condorSection.style.display = 'block';
        }

        adjust_form();

        lcg_config.style.display = 'none';
        customenv_config.style.display = 'block';
        jupyterLabOption.checked = true;
        jupyterLabOption.setAttribute('disabled', '');
    }

    /**
     * Modifies the displayed form according to the selected type of configuration (LCG or Custom Environments)
     */
     function toggle_form() {
        var lcgOption = document.getElementById('lcgOption');

        var customenv_config = document.getElementById('customenv_config');
        var external_res_config = document.getElementById('external_res_config');
        var condorSection = document.getElementById('condorSection');
        var lcg_config = document.getElementById('lcg_config');
        var jupyterLabOption = document.getElementById('use-jupyterlab');

        adjust_form();

        const urlParams = new URLSearchParams(window.location.search);
        const software_source = urlParams.get('software_source');
        const is_software_source_valid = software_source && Object.keys(sourceConfig).includes(software_source);
        const query_map = {
            checkboxes: {
                "use-jupyterlab": 'use-jupyterlab',
                "use-local-packages":'use-local-packages',
            },
            selectors: {
                "cores": "coresOptions",
                "memory": "memoryOptions",
                "lcg": "lcgOptions",
                "platforms": "platformOptions",
                "clusters": "clusterOptions",
                "condor": "condorOptions",
                "builder": "builderOptions",
            },
            inputs: {
                "scriptenv": "scriptenvOption",
                "repository": "repositoryOption",
                "file": "fileOption",
            },
        }
        if (is_software_source_valid) {
            set_checkbox(`${software_source}Option`, true);
            document.querySelectorAll('input[name="software_source"]:not(:checked)').forEach((elem) => elem.disabled = true);
            for (const [param, elem] of Object.entries(query_map.checkboxes)) {
                const checked = (urlParams.get(param) || "").toLowerCase() === 'true';
                set_checkbox(elem, checked);
            }
            for (const [param, elem] of Object.entries(query_map.selectors)) {
                const selected = urlParams.get(param) || get_default_option(elem);
                set_input(elem, selected);
            }
            for (const [param, elem] of Object.entries(query_map.inputs)) {
                const value = urlParams.get(param) || "";
                set_input(elem, value);
            }
            if (urlParams.get('file') !== null  && urlParams.get('file') !== '') {
                toggle_visibility('file_config');
            }
        } else if (software_source !== null) {
            build_error_message(`Invalid software source: ${software_source}`);
        }

        if (lcgOption.checked) {
            lcg_config.style.display = 'block';
            customenv_config.style.display = 'none';
            external_res_config.style.display = 'block';
            condorSection.style.display = 'block';
            if (is_software_source_valid) {
                adjust_options();
            } else {
                jupyterLabOption.checked = previous_jupyterlab;
            }
            adjust_platforms();
        } else {
            previous_jupyterlab = jupyterLabOption.checked;
            adjust_clusters(external_res_config, condorSection, lcg_config, customenv_config, jupyterLabOption);
        }
    }

    window.onload = toggle_form;
//-->
</script>
<div>
    <label for="placeholder">
    <span class='nb' id="optionsHeader">Specify the configuration parameters for the SWAN container that will be created for you.</span>
    </label>
    <label for="alma9">
    <span class='news' id="alma9">Try out our new experimental interface based on <b>JupyterLab</b> and let us know your feedback!</span>
    </label>
    <br><br>
    <label> User Interface <a href="#" onclick="toggle_visibility('userInterfaceDetails');"><span class='nbs'>more...</span></a></label>
    <div style="display:none;" id="userInterfaceDetails">
        <span class='nb'>JupyterLab is the latest web-based interactive development environment for notebooks, code and data. More information <a target="_blank" href="https://jupyterlab.readthedocs.io/en/stable/user/interface.html">here</a>.</span>
    </div>
    <div style="display: flex; align-items: center">
      <input
        id="use-jupyterlab"
        type="checkbox"
        name="use-jupyterlab"
        value="checked"
        style="display: inline; width: initial; margin: 0 8px 0 0"
        onchange="adjust_platforms();"
      />
      <span> Try the new JupyterLab interface (experimental)</span>
      <br>
    </div>

    <!-- Source Type selection -->
    <div id="software_sourceSection">
        <h2>Software</h2>
        <label>Source <a href="#" onclick="toggle_visibility('sourceDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="sourceDetails">
                <span class='nb'>Software source: curated stack (LCG) or custom environment.</span>
            </div>
        </label>
        <br>
        <input type="radio" id="lcgOption" name="software_source" value="lcg" checked onchange="toggle_form();" style="width: auto; height: auto; display: inline-block;">
        <label for="lcgOption" style="margin-right: 5%;">LCG</label>
        <input type="radio" id="customenvOption" name="software_source" value="customenv" onchange="toggle_form();" style="width: auto; height: auto; display: inline-block;">
        <label for="customenvOption">Custom Environment</label>
        <br><br>
    </div>

    <!-- LCG configuration -->
    <div id="lcg_config">
        <div id="lcgSection">
            <label for="lcgOptions">Software stack <a href="#" onclick="toggle_visibility('lcgDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="lcgDetails">
                    <span class='nb'>The software stack to associate to the container. See the <a target="_blank" href="http://lcginfo.cern.ch/">LCG package info</a> page.</span>
                    <br>
                    <span class='nb'>Additionally, it is possible to use Python packages installed by the user on CERNBox. More information <a target="_blank" href="https://swan.docs.cern.ch/advanced/install_packages/">here</a>.</span>
                </div>
            </label>
            <select id="lcgOptions" name="lcg" onchange="adjust_form();"></select>
            <div style="display: flex; align-items: center">
                <input
                  id="use-local-packages"
                  type="checkbox"
                  name="use-local-packages"
                  value="checked"
                  style="display: inline; width: initial; margin: 0 8px 0 0"
                  onchange="adjust_platforms();"
                />
                <span> Use Python packages installed on CERNBox</span>
            </div>
        </div>
        <br>

        <div id="platformSection">
            <label for="platformOptions">Platform <a href="#" onclick="toggle_visibility('platformDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="platformDetails">
                    <span class='nb'>The combination of compiler version and flags.</span>
                </div>
            </label>
            <select id="platformOptions" name="platforms" onchange="adjust_options();"></select>
            <input type="hidden" id="hiddenPlatformOptions" name="platforms">
        </div>
        <br>

        <div id="scriptenvSection">
            <label for="scriptenvOption">Environment script <a href="#" onclick="toggle_visibility('scriptenvDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="scriptenvDetails">
                    <span class='nb'>User-provided bash script to define custom environment variables. The variable CERNBOX_HOME is resolved to the proper /eos/user/u/username directory.</span>
                </div>
            </label>
            <input type="text" id="scriptenvOption" name="scriptenv" placeholder="e.g. $CERNBOX_HOME/MySWAN/myscript.sh">
        </div>
        <br>
    </div>

    <!-- Custom environment configuration -->
    <div id="customenv_config" style="display: none;">
        <div id="repositorySection">
            <label for="repositoryOption">Repository 
                <a href="#" onclick="toggle_visibility('repositoryDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="repositoryDetails">
                    <span class='nb'>URL of a public git repository containing a requirements.txt file.</span>
                </div>
            </label>
            <br>
            <div style="display: flex;">
                <input 
                    type="text"
                    id="repositoryOption"
                    name="repository"
                    style="flex-grow: 1; margin-left: 0; border: 1px solid #afafaf;"
                    placeholder="e.g. https://gitlab.cern.ch/user/myrepo"
                    oninput="validate_repository_input();"
                />
            </div>
        </div>
        <br>

        <div id="builderSection">
            <label for="builderOptions">Builder <a href="#" onclick="toggle_visibility('builderDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="builderDetails">
                    <span class='nb'>Program responsible for building the custom environment (generic or community-specific).</a></span>
                </div>
            </label>
            <select id="builderOptions" name="builder" onchange="adjust_clusters();"></select>
        </div>
        <br>
    </div>

    <!-- Resources configuration -->
    <div id="resources_config">
        <h2>Session resources</h2>

        <div id="coresSection">
            <label for="coresOptions">Number of cores <a href="#" onclick="toggle_visibility('coresDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="coresDetails">
                    <span class='nb'>Amount of cores allocated to the container.</span>
                </div>
            </label>
            <select id="coresOptions" name="cores"></select>
        </div>
        <br>

        <div id="memorySection">
            <label for="memoryOptions">Memory <a href="#" onclick="toggle_visibility('memoryDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="memoryDetails">
                    <span class='nb'>Amount of memory allocated to the container.</span>
                </div>
            </label>
            <select id="memoryOptions" name="memory"></select>
        </div>
        <br>
    </div>

    <!-- External computing resources -->
    <div id="external_res_config" style="display: block;">
        <h2>External computing resources</h2>
        
        <div id="clusterSection">
            <label for="clusterOptions">Spark cluster <a href="#" onclick="toggle_visibility('clustersDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="clustersDetails">
                    <span class='nb'>Name of the Spark cluster to connect to from notebooks. See the <a target="_blank" href="https://hadoop-user-guide.web.cern.ch/">Hadoop User guide</a> and the <a target="_blank" href="https://sparktraining.web.cern.ch/">Spark training course</a></span>
                </div>
            </label>
            <select id="clusterOptions" name="clusters"></select>
        </div>
        <br>

        <div id="condorSection">
            <label for="condorOptions">HTCondor pool <a href="#" onclick="toggle_visibility('condorDetails');"><span class='nbs'>more...</span></a>
                <div style="display:none;" id="condorDetails">
                    <span class='nb'>Name of the HTCondor pool to use.</span>
                </div>
            </label>
            <select id="condorOptions" name="condor"></select>
        </div>
        <br>
    </div>

    <!-- File path information text -->
    <div id="file_config" style="display: none;">
        <h2>Open File</h2>
        <label for="fileOption">File path <a href="#" onclick="toggle_visibility('fileDetails');"><span class='nbs'>more...</span></a>
            <div style="display:none;" id="fileDetails">
                <span class='nb'>Relative path of the file to be opened after the session is launched. For LCG sessions, it is relative to CERNBOX_HOME; for Custom Environments, it is relative to the specified repository root.</span>
            </div>
        </label>
        <input type="text" id="fileOption" name="file">
        <br>
    </div>
</div>
